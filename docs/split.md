## 检索增强生成（Retrieval Augmented Generation, RAG）

检索增强生成**引用**是指提供外部知识给大预言模型，对于用户提问，通过信息检索技术加载与问题相关的信息，LLM利用这些信息回答问题。下图是检索增强生成的简单示意图。检索增强生成可以解决大模型在以下四个方面的欠缺。

![示意图]()

1. 长尾知识**引用**

   LLM的海量训练数据也无法覆盖所有知识，在有限的参数量下，LLM也无法完全记忆所有知识。实践证明，LLM对长尾知识回答的准确性相比于通用知识差不少**引用**。

2. 数据时效性

   训练数据中不包含未来的事实，LLM的知识存在过时的情况。

3. 私有数据

   训练数据都是公开的数据，LLM没有未学习过的私有知识，如企业内部规章制度，特定领域业务知识等。

4. 来源和可解释性

   LLM的生成结果是不可解释的，没有来源和参考依据，使用检索增强的方式可以追溯到信息来源。

## 知识库构建

**流程图**

### 文档处理

外部文档包括txt、pdf、word、html等格式，部分格式的数据是结构化的，可以比较完整地提取出文档的标题、段落、表格中的信息，如html、word；部分格式没有或无法识别到样式信息，是非结构化的，如pdf，txt，pdf中还可以包含图片、表格等信息。

知识库的质量是检索和生成的基础，文档切分需要尽可能保证知识的完整性和关联性。对于不同格式内容的文档，要采取不同的切分策略；由于向量模型和LLM输入长度的的限制，分块大小也是需要考虑的重要因素；文档的标题索引是对段落信息的浓缩，能提高跨段落问题的检索准确度。

规章制度主要是pdf文档。pdf内容的解析一直是业界的难题。由于pdf技术规范复杂，设计理念主要关注渲染结果，忽略了文档结构信息，机器无法准确识别文档的逻辑和语义结构**引用**。本文使用了基于规则和基于智能识别模型的方式提取pdf内容信息。

#### 基于规则提取

对于按标题、章节、条目规范组织，有特定格式的文档可以使用基于正则表达式匹配的方式进行切分。首先对提取到的文本替换、删除特殊字符，按段落进行划分，匹配每个段落的章节条信息，组织成文档树的形式，每个叶子节点是文本段落，非叶子节点是标题，遍历整棵树，可以提取到文档的内容和结构信息，按照标题层级、块大小将叶子节点的文本段落合并为父文档，同时存储子文档和父文档，二者同时用于检索，最终返回上下文语义更完整的父文档。

由于各种文档格式多变，一些文档年限比较久远，实际处理过程中还有很多细节需要调整，部分文档难以达到理想的切分效果，但实际应用中对数据也没有严格的要求，该方案简单可行。

#### 不规则文档处理

基于规则的切分方式无法处理标题组织个性化、pdf文字提取不完全的、包含表格、图片的文档，需要机器像人一样去识别文档结构，理解表格图片信息。

基于深度学习的PP-StructureV2是一个智能文档分析系统，支持对图片/pdf形式的文档进行版面分析，可以划分文字、标题、表格、图片、公式等区域，支持通用的中英文表格检测任务，表格区域进行结构化识别，最终结果输出Excel文件，在专门的数据集上进行训练后识别准确度更高。

### 多模态数据

除了最常见的各种格式文档外，外部数据还可能是多模态的，比如视频、音频、图片等格式，需要专门的多模态模型识别。

## 检索模块

![]()

使用Elasticseach进行全文检索和向量检索，对词汇和语义进行双路召回，对召回结果进行相关度重排，取评分最高的top k个文档片段，最终返回topk个语义更完整的父文档。

### 向量检索

传统的相似语义判断是基于词汇匹配的，无法表示文本的内在特征。向量检索将文本表示为维度相同的特征向量，使用向量相似度度量的方式判断语义相关性。本文使用的向量模型来自MTEB（[Massive Text Embedding Benchmark](https://arxiv.org/abs/2210.07316)）评测榜单，并在专业数据上进行了微调，使用Elasticsearc的KNN向量检索，向量距离度量方式为点积，在检索速度和准确度方面都有不错的效果。

### BM25检索

基于概率的BM25检索算法是当前使用效果最好的算法之一，被广泛应用于信息检索领域。本文使用开源搜索分析引擎Elasticseach完成全文检索，其默认使用的算法就是BM25。文档切块之后，将标题、段落信息存入ES建立倒排索引，检索阶段对用户提问进行分词、去除停用词、同义词替换等处理，按BM25算法评分召回top k个段落。

分词策略、词库大小是影响检索准确度的重要因素，全文检索在一定程度上可以弥补向量检索在专业领域上的不足，因为向量模型的训练语料大多来自通用领域。

### 语义重排

对向量检索和全文检索的结果进一步进行相关度排序，使用重排模型对查询和答案计算相关性分数并重新排序，分数低于阈值直接过滤，重排后显著提高topk召回的准确率。

### 缓存

考虑到算力问题，可以根据用户对回答的满意度将命中的历史问题放入缓存，提高响应速度，减少资源占用。

## 回答生成模块

![]()

对于检索出的topk个文本段落，将问题和相关文本依次组合成提示词交给LLM总结、修正，最终生成准确的答案。

## 结果分析

### 检索策略对比

|                            | top1 | top5 | top10 |
| :------------------------: | :--: | :--: | :---: |
|          向量检索          |      |      |       |
|     BM25+向量检索+重排     |      |      |       |
| BM25+多路向量检索+RRF+重排 |      |      |       |

### 向量模型微调前后对比

|      |      |      |
| ---- | ---- | :--: |
|      |      |      |
|      |      |      |
|      |      |      |

### 国产化与非国产化环境响应时间对比

|      |      |      |
| ---- | ---- | ---- |
|      |      |      |
|      |      |      |
|      |      |      |

### 界面截图
